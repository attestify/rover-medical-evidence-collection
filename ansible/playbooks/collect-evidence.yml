---
- name: Load release profile and set common paths
  hosts: localhost
  gather_facts: false
  vars:
    # Required input, passed from workflow:
    # ansible-playbook ... -e "release=release-3"
    release: "{{ release | default('release-1') }}"

    # Optional input, passed from workflow:
    rover_system_root: "{{ rover_system_root | default(playbook_dir ~ '/../../rover-medical-system') | realpath }}"
    release_profile_file: "{{ playbook_dir }}/../vars/releases/{{ release }}.yml"

    collectors:
      pet_med_db: false
      pet_med_host: false
      rover_cloud: false
      attestify_soc1: false

  tasks:
    - name: Show resolved inputs
      ansible.builtin.debug:
        msg:
          - "release={{ release }}"
          - "rover_system_root={{ rover_system_root }}"
          - "release_profile_file={{ release_profile_file }}"
          - "evidence_root={{ rover_system_root }}"

    - name: Check if release profile exists
      ansible.builtin.stat:
        path: "{{ release_profile_file }}"
      register: rel_profile

    - name: Load release profile vars when present
      ansible.builtin.include_vars:
        file: "{{ release_profile_file }}"
      when: rel_profile.stat.exists

    - name: Export resolved variables to other plays
      ansible.builtin.set_fact:
        release_resolved: "{{ release }}"
        rover_system_root_resolved: "{{ rover_system_root }}"
        evidence_root_resolved: "{{ evidence_root }}"
        collectors_resolved: "{{ collectors }}"

- name: Collect Pet Medicine DB evidence (simulated)
  hosts: db
  gather_facts: false
  vars:
    release: "{{ hostvars['localhost'].release_resolved }}"
    rover_system_root: "{{ hostvars['localhost'].rover_system_root_resolved }}"
    evidence_root: "{{ hostvars['localhost'].evidence_root_resolved }}"
    collectors: "{{ hostvars['localhost'].collectors_resolved }}"
  roles:
    - role: pet_med_db_collect
      when: collectors.pet_med_db | bool

- name: Collect Pet Medicine Host evidence (simulated)
  hosts: host
  gather_facts: false
  vars:
    release: "{{ hostvars['localhost'].release_resolved }}"
    rover_system_root: "{{ hostvars['localhost'].rover_system_root_resolved }}"
    evidence_root: "{{ hostvars['localhost'].evidence_root_resolved }}"
    collectors: "{{ hostvars['localhost'].collectors_resolved }}"
  roles:
    - role: pet_med_host_collect
      when: collectors.pet_med_host | bool

- name: Collect Rover Cloud evidence (simulated)
  hosts: cloud
  gather_facts: false
  vars:
    release: "{{ hostvars['localhost'].release_resolved }}"
    rover_system_root: "{{ hostvars['localhost'].rover_system_root_resolved }}"
    evidence_root: "{{ hostvars['localhost'].evidence_root_resolved }}"
    collectors: "{{ hostvars['localhost'].collectors_resolved }}"
  roles:
    - role: rover_cloud_collect
      when: collectors.rover_cloud | bool
    - role: attestify_soc1_collect
      when: collectors.attestify_soc1 | bool